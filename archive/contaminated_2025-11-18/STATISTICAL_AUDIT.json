{
  "audit_date": "2025-11-18",
  "audit_type": "Statistical Correctness - Round 4 (empyrical library)",
  "verdict": "CRITICAL_ERRORS_FOUND",
  "critical_errors": [
    {
      "id": "ERR-001",
      "severity": "CRITICAL",
      "type": "Input Type Mismatch",
      "location": "src/analysis/metrics_empyrical.py:38",
      "description": "empyrical library functions receive DOLLAR P&L instead of percentage RETURNS. This causes Sharpe ratio, Sortino ratio, and all risk-adjusted metrics to be inflated 100,000x or become infinite.",
      "root_cause": "src/backtest/portfolio.py creates 'portfolio_pnl' as dollar amounts. src/analysis/metrics_empyrical.py passes this directly to empyrical which expects decimal returns (0.001 = 0.1%, not $1000).",
      "code_location": {
        "file": "src/analysis/metrics_empyrical.py",
        "lines": [
          38,
          39,
          40,
          41,
          42,
          43,
          44,
          45,
          46,
          47,
          48
        ],
        "context": "returns = portfolio['portfolio_pnl']\nmetrics = {'sharpe_ratio': ep.sharpe_ratio(returns, period='daily'), ...}"
      },
      "impact": "ALL PUBLISHED METRICS ARE STATISTICALLY INVALID",
      "fix": "Use portfolio['portfolio_return'] instead of portfolio['portfolio_pnl']. Single-line change.",
      "fix_code": "returns = portfolio['portfolio_return']  # Use returns, not dollar P&L",
      "examples": [
        "True Sharpe 1.0 \u2192 Reported as Infinite or 100,000+",
        "True return 25% \u2192 Reported as meaningless",
        "True vol 16% \u2192 Reported as meaningless"
      ]
    }
  ],
  "high_severity_issues": [
    {
      "id": "ISSUE-002",
      "severity": "HIGH",
      "type": "Small Sample Size",
      "location": "src/regimes/classifier.py",
      "description": "Two regimes have <30 observations, which is below minimum for reliable statistical testing.",
      "details": {
        "Compression": {
          "count": 31,
          "percentage": 4.4,
          "status": "Barely adequate (n=31)"
        },
        "Breaking Vol": {
          "count": 25,
          "percentage": 3.6,
          "status": "Insufficient (n=25)"
        }
      },
      "recommendation": "Extend backtest period by 6-9 months to accumulate 50+ observations per regime, or handle small-sample regimes separately",
      "impact": "Statistical tests on these regimes are unreliable"
    }
  ],
  "warnings": [
    {
      "id": "WARN-001",
      "type": "Multiple Testing",
      "description": "System performs approximately 107 statistical tests without documented multiple testing correction.",
      "estimated_tests": {
        "Individual Sharpe ratios": 6,
        "Regime-conditional Sharpes": 36,
        "Profile feature correlations": 10,
        "Greeks significance tests": 20,
        "Transaction cost tests": 5,
        "Regime transition tests": 6,
        "Profitability tests per regime": 6,
        "Parameter sensitivity tests": 18,
        "total": 107
      },
      "false_positive_analysis": {
        "expected_false_positives": 5.4,
        "probability_any_false_positive": 0.996,
        "bonferroni_alpha": 0.000467,
        "recommendation": "Apply Holm-Bonferroni correction"
      }
    },
    {
      "id": "WARN-002",
      "type": "Walk-Forward Compliance",
      "description": "Must verify that all P&L calculations use walk-forward compliant regime/profile scores (no lookahead bias)"
    },
    {
      "id": "WARN-003",
      "type": "IV Proxy Fallback",
      "description": "IV proxies use forward-looking VIX data (good), but have fallback to backward-looking RV (less predictive)"
    }
  ],
  "sample_size_analysis": {
    "total_observations": 698,
    "date_range": "2023-01-03 to 2025-10-14",
    "years_of_data": 2.77,
    "trading_days": 698,
    "valid_for_statistics": 678,
    "valid_percentage": 97.1,
    "sufficient_for_sharpe_tests": true,
    "minimum_required": 100,
    "missing_data": {
      "close": 0,
      "RV20": 20,
      "regime_label": 0
    },
    "assessment": "ADEQUATE - 678 observations is sufficient for reliable statistical testing. Minimum is 100-250, we have 678."
  },
  "regime_distribution": {
    "total_regimes": 6,
    "regimes": {
      "Trend Up": {
        "count": 197,
        "percentage": 28.2,
        "sufficient": true
      },
      "Trend Down": {
        "count": 54,
        "percentage": 7.7,
        "sufficient": true
      },
      "Compression": {
        "count": 31,
        "percentage": 4.4,
        "sufficient": false
      },
      "Breaking Vol": {
        "count": 25,
        "percentage": 3.6,
        "sufficient": false
      },
      "Choppy": {
        "count": 282,
        "percentage": 40.4,
        "sufficient": true
      },
      "Event": {
        "count": 109,
        "percentage": 15.6,
        "sufficient": true
      }
    },
    "regimes_below_minimum": 2,
    "assessment": "SPARSE - Two regimes below n=30 threshold for reliable statistical testing"
  },
  "metric_calculations": {
    "empyrical_usage": {
      "status": "CRITICAL_ERROR",
      "input_type": "WRONG - Dollar P&L instead of percentage returns",
      "impact": "All Sharpe, Sortino, Calmar ratios are invalid"
    },
    "annualization_factors": {
      "daily_returns_annualization": 252,
      "daily_volatility_annualization": 15.87,
      "status": "CORRECT"
    },
    "realized_volatility": {
      "formula": "RV = sqrt(252) * std(log returns)",
      "status": "CORRECT",
      "verified": true
    },
    "iv_ranks": {
      "method": "Rolling percentile with window=60/90",
      "walk_forward_compliant": true,
      "lookahead_bias": false,
      "status": "CORRECT"
    },
    "z_scores": {
      "formula": "(value - mean) / std",
      "method": "60-day rolling normalization",
      "epsilon": "1e-6 prevents division by zero",
      "status": "CORRECT"
    }
  },
  "feature_calculations": {
    "realized_volatility": "\u2713 CORRECT - Verified against manual calculation",
    "iv_rank_percentiles": "\u2713 CORRECT - Walk-forward compliant, range [0,1] verified",
    "z_score_normalization": "\u2713 CORRECT - Proper mean-std calculation",
    "iv_proxies": "\u2713 CORRECT - Uses VIX (forward-looking), fallback to RV"
  },
  "walk_forward_compliance": {
    "profile_features": "\u2713 CORRECT - Uses past data only",
    "regime_classification": "\u2713 CORRECT - Uses only historical data",
    "rv_calculations": "\u2713 CORRECT - Rolling window walk-forward compliant",
    "potential_risk": "Must verify P&L calculation uses walk-forward scores (no lookahead)"
  },
  "recommended_actions": [
    {
      "priority": "IMMEDIATE",
      "action": "Fix empyrical input type",
      "details": "Change src/analysis/metrics_empyrical.py line 38 from 'returns = portfolio[\"portfolio_pnl\"]' to 'returns = portfolio[\"portfolio_return\"]'",
      "timeline": "Before publishing any results",
      "impact": "All metrics become valid"
    },
    {
      "priority": "IMMEDIATE",
      "action": "Invalidate all published metrics",
      "details": "All Sharpe ratios, Sortino ratios, and risk-adjusted returns from current system are invalid due to input type mismatch",
      "timeline": "Immediately",
      "impact": "Prevents deployment of invalid strategy"
    },
    {
      "priority": "SHORT_TERM",
      "action": "Extend backtest period",
      "details": "Add 6-9 months of data to get 50+ observations per regime (especially Breaking Vol and Compression)",
      "timeline": "Before next major validation",
      "impact": "Enables reliable statistical testing on all 6 regimes"
    },
    {
      "priority": "SHORT_TERM",
      "action": "Apply multiple testing corrections",
      "details": "If reporting p-values, apply Holm-Bonferroni correction for 107 tests",
      "timeline": "When re-running backtests",
      "impact": "Prevents false positive results"
    },
    {
      "priority": "SHORT_TERM",
      "action": "Code review walk-forward compliance",
      "details": "Verify all profile scores and regime labels at time t use only data through time t",
      "timeline": "Before strategy deployment",
      "impact": "Confirms no lookahead bias"
    }
  ],
  "conclusion": {
    "verdict": "CRITICAL_ERRORS_FOUND",
    "summary": "System has one critical data type error (dollar P&L instead of returns) that invalidates all risk-adjusted metrics. Sample size is adequate, methodologies are sound, but the input type bug must be fixed immediately.",
    "all_metrics_valid": false,
    "can_deploy": false,
    "timeline_to_fix": "~30 minutes (single line change + re-run backtests)",
    "timeline_to_full_validation": "~2-3 weeks (including 6-9 month data extension)"
  }
}