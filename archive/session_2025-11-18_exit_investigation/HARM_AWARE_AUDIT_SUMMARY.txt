HARM-AWARE STRUCTURAL RULE SEARCH - RED TEAM AUDIT SUMMARY
===============================================================================
Date: 2025-11-18
File: scripts/harm_aware_structural_rule_search.py
Status: DO NOT DEPLOY - CRITICAL BUGS FOUND

CRITICAL BUGS (3):
===============================================================================

#1 - Division by Zero (Line 294)
   Code: (conf['TP']-conf['FP'])/(conf['TP']+conf['FP'])*100
   Crash: When TP+FP=0
   Fix: Use max(1, conf['TP']+conf['FP']) like line 188
   Time: 5 min

#2 - Division by Zero (Line 295)
   Code: conf['FN']/(conf['FN']+conf['TN'])*100
   Crash: When FN+TN=0 (all trades removed)
   Fix: Check remaining > 0 before division
   Time: 5 min

#3 - GATE 4 NOT IMPLEMENTED (Lines 180-192)
   Missing: Coarseness check (neighboring percentiles)
   Impact: Overfitted rules deployed → capital loss
   Risk: HIGH - rules won't generalize to live data
   Fix: Implement check_coarseness() function
   Time: 2 hours

HIGH BUGS (2):
===============================================================================

#4 - Empty Array to np.percentile (Lines 147, 165)
   Crash: If year has 0 trades or all NaN features
   Likelihood: LOW (data has no missing features)
   Fix: Check len(valid_values) > 0 before percentile
   Time: 10 min

#5 - Year With Imbalanced Classes (Lines 194-210)
   Issue: Year with only peakless or only winners passes falsely
   Impact: False confidence in rule robustness
   Fix: Require min_per_class >= 2
   Time: 10 min

VERIFIED CORRECT:
===============================================================================
✓ Confusion matrix logic (TP, FP, FN, TN)
✓ Net benefit calculation in check_gates() (line 188)
✓ NaN handling (pandas treats NaN <= threshold as False)

WHAT PASSED AUDIT:
===============================================================================
- Code structure is clean and logical
- Variable names are clear
- Comments explain intent well
- Separation of concerns (test_1d_rule, check_gates, check_year_robustness)

WHAT FAILED:
===============================================================================
- Gate 4 completely missing (CRITICAL for preventing overfitting)
- No protection against division by zero in display code
- No minimum sample size check for year robustness
- No edge case handling for empty arrays

DEPLOYMENT DECISION:
===============================================================================
DO NOT DEPLOY until:

1. Fix division by zero (bugs #1, #2) - 15 min
2. Implement Gate 4 coarseness check - 2 hours
3. Add minimum sample size to G3 - 10 min
4. Add empty array protection - 10 min
5. Re-run full search with all gates
6. Manual review of surviving rules

Total fix time: ~3 hours

CAPITAL RISK IF DEPLOYED AS-IS:
===============================================================================
HIGH - Missing Gate 4 means overfitted rules will be deployed

Expected impact:
- Rules work in backtest (60% peakless removal)
- Rules fail live (20% peakless removal)
- False edge → deploy undisciplined strategy
- Estimated P&L impact: -10% to -30%
- Probability: 30-50% (many rules may be overfitted)

WHY GATE 4 IS CRITICAL:
===============================================================================
Without G4, system can find "magic percentile" that works by luck:

Example:
  40th: TP=5, FP=8  → FAIL G1
  50th: TP=10, FP=3 → PASS ← Selected!
  60th: TP=6, FP=7  → FAIL G1

This rule ONLY works at 50th percentile = noise-fit, won't generalize.

With G4: Neighboring percentiles must ALSO pass G1 and maintain net benefit.
Ensures rule is robust to threshold variation.

NEXT ACTIONS:
===============================================================================
1. Apply all 5 bug fixes (see HARM_AWARE_RULE_SEARCH_BUGFIXES.md)
2. Test edge cases (division by zero, empty arrays)
3. Re-run search on full 2020-2024 data
4. Expect FEWER rules to pass (G4 is strict)
5. Higher confidence in rules that DO pass
6. Manual review before deployment

FILES CREATED:
===============================================================================
- HARM_AWARE_RULE_SEARCH_AUDIT_REPORT.md (full audit)
- HARM_AWARE_RULE_SEARCH_BUGFIXES.md (code patches)
- HARM_AWARE_AUDIT_SUMMARY.txt (this file)

AUDIT VERDICT:
===============================================================================
Code finds structural rules BUT cannot guarantee they generalize.
Fix Gate 4 before deployment or risk capital loss.

Confidence after fixes: HIGH
Estimated degradation with G4: 50-70% of rules will be rejected
Remaining rules: More robust, better generalization

Real quant shop discipline = NO SHORTCUTS.
